<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Real-Time Indian Stocks</title>
  <!-- Load libraries: Luxon, Chart.js, Chart.js Luxon adapter, Axios -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.6.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.9.0/dist/axios.min.js"></script>
  <style>
    :root {
      --saffron: #FF9933;
      --green: #138808;
      --blue: #000080;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      background: linear-gradient(135deg, var(--saffron), var(--green));
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
    }
    .stat-label {
      color: #64748b;
      font-size: 1rem;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      height: 500px;
      margin-bottom: 25px;
    }
    footer {
      text-align: center;
      color: #64748b;
      padding: 20px;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>NSE Real-Time Market Data</h1>
      <p>Powered by Upstox API & Apache Spark</p>
    </header>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">Current Price</div>
        <div class="stat-value" id="currentPrice">₹0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">5-min Avg</div>
        <div class="stat-value" id="movingAvg">₹0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Stock</div>
        <div class="stat-value" id="stockName">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Time (IST)</div>
        <div class="stat-value" id="time">--:--</div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="priceChart"></canvas>
    </div>

    <footer>
      Real-time analysis | Data updates every 3 seconds | Mumbai Time (IST)
    </footer>
  </div>

 <script>
    const ctx = document.getElementById('priceChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'minute',
              tooltipFormat: 'HH:mm:ss'
            },
            title: {
              display: true,
              text: 'Indian Standard Time'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Moving Avg Price (₹)'
            },
            ticks: {
              callback: value => '₹' + value
            }
          }
        }
      }
    });

    function updateDashboard() {
      axios.get('/data')
        .then(response => {
          const prices = response.data.prices;
          if (!prices || prices.length === 0) return;

          const grouped = {};
          for (const p of prices) {
            const key = `${p.symbol}-${p.start}`;
            if (!grouped[p.symbol]) grouped[p.symbol] = {};
            grouped[p.symbol][key] = {
              x: new Date(p.timestamp || p.start),
              y: p.avg
            };
          }

          chart.data.datasets = Object.keys(grouped).map((symbol, i) => ({
            label: symbol,
            data: Object.values(grouped[symbol]),
            borderColor: ['#FF9933', '#138808', '#000080', '#e53e3e'][i % 4],
            backgroundColor: 'rgba(0,0,0,0)',
            borderWidth: 2,
            pointRadius: 3,
            fill: false,
            tension: 0.2
          }));

          chart.update();

          const latest = prices.reduce((a, b) =>
            new Date(a.timestamp) > new Date(b.timestamp) ? a : b
          );

          document.getElementById('currentPrice').textContent = '₹' + latest.ltp.toFixed(2);
          document.getElementById('movingAvg').textContent = '₹' + latest.avg.toFixed(2);
          document.getElementById('stockName').textContent = latest.symbol;
          document.getElementById('time').textContent = new Date(latest.start).toLocaleTimeString();
        })
        .catch(error => {
          console.error("Error fetching data:", error);
        });
    }

    setInterval(updateDashboard, 3000);
    updateDashboard();
  </script>

</body>
</html>
